name: Publish audit snapshot

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/archived/**'
      - '.github/workflows/publish-audit-snapshot.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history not required)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare sanitized snapshot
        run: |
          set -euo pipefail
          mkdir -p audit-snapshot
          # Include only the code we want to expose publicly
          rsync -a --delete \
            apps/ audit-snapshot/apps/ \
            services/ audit-snapshot/services/ \
            infra/ audit-snapshot/infra/ \
            .github/workflows/ audit-snapshot/.github/workflows/ \
            README.md ENGINEERING_OVERVIEW.md QUICKSTART.md \
            DEPLOYMENT.md CONTRIBUTING.md ROADMAP.md CHANGELOG.md TROUBLESHOOTING.md \
            audit-snapshot/

          # Exclude secrets & junk
          rm -rf audit-snapshot/**/node_modules \
                 audit-snapshot/**/.next \
                 audit-snapshot/**/__pycache__ \
                 audit-snapshot/**/.env* \
                 audit-snapshot/**/.cursor \
                 audit-snapshot/**/dist \
                 audit-snapshot/**/build

          # Lightweight manifest so GPT-5 can sanity-check quickly
          find audit-snapshot -type f | LC_ALL=C sort > audit-snapshot/MANIFEST.txt

      - name: Initialize mirror repo
        working-directory: audit-snapshot
        run: |
          set -euo pipefail
          git init -b main
          git config user.name "audit-bot"
          git config user.email "audit-bot@users.noreply.github.com"
          git add .
          git commit -m "Audit snapshot: $GITHUB_SHA ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"

      - name: Push to public mirror
        env:
          MIRROR_TOKEN: ${{ secrets.GH_MIRROR_TOKEN }}
          MIRROR_REPO: hankthevc/AGITracker-audit-mirror
        working-directory: audit-snapshot
        run: |
          set -euo pipefail
          # Avoid printing token in logs
          git remote add origin "https://x-access-token:${MIRROR_TOKEN}@github.com/${MIRROR_REPO}.git"
          # Force push to ensure clean state
          git push -f origin main
