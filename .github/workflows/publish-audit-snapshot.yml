name: Publish audit snapshot

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/archived/**'
      - '.github/workflows/publish-audit-snapshot.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history not required)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Prepare sanitized snapshot
        run: |
          set -euo pipefail
          mkdir -p audit-snapshot
          
          # Copy directories that exist (gracefully handle missing ones)
          [ -d "apps" ] && rsync -a apps/ audit-snapshot/apps/ || echo "apps/ not found"
          [ -d "services" ] && rsync -a services/ audit-snapshot/services/ || echo "services/ not found"
          [ -d "infra" ] && rsync -a infra/ audit-snapshot/infra/ || echo "infra/ not found"
          [ -d ".github/workflows" ] && rsync -a .github/workflows/ audit-snapshot/.github/workflows/ || echo "workflows not found"
          [ -d "docs" ] && rsync -a docs/ audit-snapshot/docs/ || echo "docs/ not found"
          
          # Copy top-level docs that exist
          for doc in README.md ENGINEERING_OVERVIEW.md QUICKSTART.md DEPLOYMENT.md CONTRIBUTING.md ROADMAP.md CHANGELOG.md TROUBLESHOOTING.md GPT5_AUDIT_RESPONSE.md MIGRATION_POLICY_FIX.md FINAL_GPT5_VERIFICATION.md COMPLETE_AUDIT_VERIFIED.md; do
            [ -f "$doc" ] && cp "$doc" audit-snapshot/ || echo "$doc not found (skipping)"
          done

          # Exclude secrets & build artifacts
          rm -rf audit-snapshot/**/node_modules \
                 audit-snapshot/**/.next \
                 audit-snapshot/**/__pycache__ \
                 audit-snapshot/**/.env* \
                 audit-snapshot/**/.cursor \
                 audit-snapshot/**/dist \
                 audit-snapshot/**/build \
                 audit-snapshot/**/*.pyc

          # Create manifest for GPT-5
          find audit-snapshot -type f | LC_ALL=C sort > audit-snapshot/MANIFEST.txt
          
          echo "âœ… Snapshot prepared: $(find audit-snapshot -type f | wc -l) files"

      - name: Initialize mirror repo
        working-directory: audit-snapshot
        run: |
          set -euo pipefail
          git init -b main
          git config user.name "audit-bot"
          git config user.email "audit-bot@users.noreply.github.com"
          git add .
          git commit -m "Audit snapshot: $GITHUB_SHA ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"

      - name: Push to public mirror
        env:
          MIRROR_TOKEN: ${{ secrets.GH_MIRROR_TOKEN }}
          MIRROR_REPO: hankthevc/AGITracker-audit-mirror
        working-directory: audit-snapshot
        run: |
          set -euo pipefail
          # Avoid printing token in logs
          git remote add origin "https://x-access-token:${MIRROR_TOKEN}@github.com/${MIRROR_REPO}.git"
          # Force push to ensure clean state
          git push -f origin main
