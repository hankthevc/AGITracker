name: Dependency Updates

on:
  schedule:
    - cron: '0 9 * * 1'  # Monday at 9 AM UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  audit-npm:
    name: Audit npm Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'apps/web/package-lock.json'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run npm audit
        id: npm-audit
        run: |
          npm audit --json > npm-audit.json || true
          npm audit --audit-level=moderate || echo "::warning::npm audit found vulnerabilities"
      
      - name: Check for outdated packages
        id: outdated
        run: |
          npm outdated --json > npm-outdated.json || true
          npm outdated || echo "::warning::Some packages are outdated"
      
      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: |
            npm-audit.json
            npm-outdated.json
          retention-days: 30

  audit-python:
    name: Audit Python Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pip-audit
          cd services/etl
          pip install -e .
      
      - name: Run pip-audit
        id: pip-audit
        run: |
          cd services/etl
          pip-audit --format json > ../../pip-audit.json || true
          pip-audit || echo "::warning::pip-audit found vulnerabilities"
      
      - name: Check for outdated packages
        id: outdated-pip
        run: |
          cd services/etl
          pip list --outdated --format json > ../../pip-outdated.json || true
          pip list --outdated || echo "::warning::Some packages are outdated"
      
      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-results
          path: |
            pip-audit.json
            pip-outdated.json
          retention-days: 30

  update-npm-dependencies:
    name: Update npm Dependencies
    runs-on: ubuntu-latest
    needs: audit-npm
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Update minor/patch versions
        run: |
          npm update --save
          cd apps/web
          npm update --save
      
      - name: Run tests
        run: |
          npm run lint || true
          cd apps/web
          npm run typecheck || true
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): Update npm dependencies'
          title: 'ðŸ”„ Weekly npm Dependency Updates'
          body: |
            ## ðŸ“¦ npm Dependency Updates
            
            This PR updates npm dependencies to their latest compatible versions.
            
            ### Changes
            - Updated minor and patch versions
            - Ran linting and type checking
            
            ### âš ï¸ Manual Review Required
            - [ ] Review changelog for breaking changes
            - [ ] Test locally
            - [ ] Check bundle size impact
            
            **Auto-generated by dependency update workflow**
          branch: deps/npm-updates-${{ github.run_number }}
          labels: dependencies,automated

  update-python-dependencies:
    name: Update Python Dependencies
    runs-on: ubuntu-latest
    needs: audit-python
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pip-tools
          cd services/etl
          pip install -e .
      
      - name: Check for security updates
        id: security
        run: |
          cd services/etl
          pip list --outdated | grep -i "security" || echo "No security updates found"
      
      - name: Create Pull Request for Security Updates
        if: steps.security.outputs.result != 'No security updates found'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): Update Python dependencies for security'
          title: 'ðŸ”’ Python Security Dependency Updates'
          body: |
            ## ðŸ”’ Python Security Updates
            
            This PR contains security updates for Python dependencies.
            
            ### Changes
            - Updated packages with known security vulnerabilities
            
            ### âš ï¸ Manual Review Required
            - [ ] Review changelog for breaking changes
            - [ ] Run tests locally
            - [ ] Verify all imports still work
            
            **Auto-generated by dependency update workflow**
          branch: deps/python-security-${{ github.run_number }}
          labels: dependencies,security,automated

  report-summary:
    name: Create Dependency Report
    runs-on: ubuntu-latest
    needs: [audit-npm, audit-python]
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download npm audit results
        uses: actions/download-artifact@v4
        with:
          name: npm-audit-results
          path: ./audit-results
        continue-on-error: true
      
      - name: Download pip audit results
        uses: actions/download-artifact@v4
        with:
          name: pip-audit-results
          path: ./audit-results
        continue-on-error: true
      
      - name: Generate summary report
        run: |
          echo "# ðŸ“Š Weekly Dependency Audit Report" > report.md
          echo "" >> report.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> report.md
          echo "" >> report.md
          
          echo "## npm Audit" >> report.md
          if [ -f audit-results/npm-audit.json ]; then
            vulnerabilities=$(jq '.metadata.vulnerabilities | to_entries | map("\(.key): \(.value)") | join(", ")' audit-results/npm-audit.json)
            echo "Vulnerabilities: $vulnerabilities" >> report.md
          else
            echo "No audit data available" >> report.md
          fi
          echo "" >> report.md
          
          echo "## Python Audit" >> report.md
          if [ -f audit-results/pip-audit.json ]; then
            echo "Results available in artifacts" >> report.md
          else
            echo "No audit data available" >> report.md
          fi
          echo "" >> report.md
          
          echo "## Recommendations" >> report.md
          echo "- Review security updates and apply critical patches" >> report.md
          echo "- Test major version updates in a separate branch" >> report.md
          echo "- Check for deprecated packages" >> report.md
          
          cat report.md
      
      - name: Create or update issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            // Search for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,automated',
              per_page: 1
            });
            
            const title = 'ðŸ“Š Weekly Dependency Audit Report';
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: report
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: report,
                labels: ['dependencies', 'automated']
              });
            }

