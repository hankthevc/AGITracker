# üöß BLOCKED - Manual Railway Configuration Required

**Date**: 2025-10-28  
**Sprint**: 4.1 - Deploy Celery Workers on Railway  
**Blocking**: Full production automation  
**Update**: Dockerfile fixed for Railway deployment

---

## ‚úÖ FIXED: Dockerfile Build Error

**Issue resolved**: The Dockerfile in `services/etl/Dockerfile` has been updated to work correctly when Railway sets the root directory to `services/etl`.

**Changes made**:
- Reordered COPY commands for better layer caching
- Added libpq-dev to system dependencies
- Simplified CMD to use uvicorn directly (Railway handles PORT)
- Removed dependency on start.sh script execution

**To deploy**: Push the latest commit and redeploy in Railway. The build should now succeed.

---

## What's Needed

The following steps require **manual configuration in Railway dashboard** by a human with access:

### 1. Add Redis Database (if not already added)

**Steps**:
1. Go to Railway dashboard: https://railway.app
2. Navigate to AGI Tracker project
3. Click "+ New" ‚Üí "Database" ‚Üí "Redis"
4. Railway will automatically create `REDIS_URL` environment variable
5. Verify Redis is connected and running

**Status**: ‚è∏Ô∏è Pending human action

---

### 2. Configure Main API Service

**Steps**:
1. In Railway project, find or create the main API service
2. Configure service:
   - **Name**: `agi-tracker-api`
   - **Root Directory**: `services/etl`
   - **Branch**: `cursor/implement-agi-tracker-phase-2-production-automation-a29d`
   - Railway will auto-detect the Dockerfile
3. Set environment variables (see section below)
4. Deploy and verify logs show: "Application startup complete"

**Status**: ‚è∏Ô∏è Pending human action

---

### 3. Create Celery Worker Service

**Steps**:
1. In Railway project, click "+ New" ‚Üí "Service"
2. Select "GitHub Repo" ‚Üí `hankthevc/AGITracker`
3. Configure service:
   - **Name**: `agi-tracker-celery-worker`
   - **Root Directory**: `services/etl`
   - **Branch**: `cursor/implement-agi-tracker-phase-2-production-automation-a29d`
   - **Custom Start Command**: `celery -A app.celery_app worker --loglevel=info`
4. Copy all environment variables from main API service
5. Click "Deploy"
6. Verify logs show: "celery@hostname ready"

**Status**: ‚è∏Ô∏è Pending human action

---

### 4. Create Celery Beat Service (Scheduler)

**Steps**:
1. In Railway project, click "+ New" ‚Üí "Service"
2. Select "GitHub Repo" ‚Üí `hankthevc/AGITracker`
3. Configure service:
   - **Name**: `agi-tracker-celery-beat`
   - **Root Directory**: `services/etl`
   - **Branch**: `cursor/implement-agi-tracker-phase-2-production-automation-a29d`
   - **Custom Start Command**: `celery -A app.celery_app beat --loglevel=info`
4. Copy all environment variables from main API service
5. Click "Deploy"
6. Verify logs show: "Scheduler: Sending due task..."

**Status**: ‚è∏Ô∏è Pending human action

---

## Environment Variables to Copy

Ensure these variables are set on **all three services** (API, Worker, Beat):

```bash
# Required
DATABASE_URL=<from Neon or Railway Postgres>
REDIS_URL=<auto-generated by Railway Redis>
OPENAI_API_KEY=<your OpenAI key>
ADMIN_API_KEY=<your admin key>

# Optional but recommended
ENVIRONMENT=production
LOG_LEVEL=info
CORS_ORIGINS=https://agi-tracker.vercel.app
LLM_BUDGET_DAILY_USD=50
SCRAPE_REAL=false

# Railway auto-provides (don't set manually)
PORT=<Railway assigns dynamically>
RAILWAY_ENVIRONMENT=production
RAILWAY_PROJECT_ID=<auto-generated>
```

**Important**: 
- For `ADMIN_API_KEY`, generate a secure random key: `openssl rand -base64 32`
- For `DATABASE_URL`, use your existing Neon database or create a Railway Postgres
- `REDIS_URL` is automatically created when you add Redis to the project

---

## Verification Steps (After Setup)

Once services are deployed, verify with these commands:

```bash
# Check worker logs
railway logs -s agi-tracker-celery-worker

# Check beat logs
railway logs -s agi-tracker-celery-beat

# Check API logs
railway logs -s agi-tracker-api

# Test Redis connection
railway run -s agi-tracker-api python -c "import redis; r=redis.from_url('$REDIS_URL'); print('‚úÖ Redis:', r.ping())"

# Check task health endpoint
curl https://agi-tracker-production.up.railway.app/v1/admin/tasks/health \
  -H "x-api-key: YOUR_API_KEY"
```

---

## Troubleshooting

### Build fails with "not found" error
**Fixed**: Update to latest commit with fixed Dockerfile

### Worker/Beat can't connect to Redis
**Solution**: Verify Redis service is running and REDIS_URL is set on worker/beat services

### API returns 500 errors
**Solution**: Check DATABASE_URL is correct and database is accessible

### Tasks not running
**Solution**: 
1. Verify beat service shows "Scheduler: Sending due task..." in logs
2. Verify worker service shows "celery@hostname ready" in logs
3. Check task health endpoint for status

---

## What I Can Do While Blocked

While waiting for Railway setup, I've implemented:

- ‚úÖ Task health monitoring endpoint (`/v1/admin/tasks/health`)
- ‚úÖ Task dashboard UI (`/admin/tasks`)
- ‚úÖ Fixed Dockerfile for Railway deployment
- ‚úÖ All Celery task definitions and schedules
- ‚úÖ Task tracking utilities
- ‚úÖ Surprise score calculation
- ‚úÖ Source credibility tracking

These will work automatically once the Railway services are deployed.

---

## Cost Estimate

**Monthly costs after setup**:
- Redis: ~$0 (included in Railway usage)
- Celery Worker: ~$5-10/month
- Celery Beat: ~$2-5/month
- **Total**: ~$7-15/month additional

---

## Next Steps

1. ‚è∏Ô∏è **BLOCKED**: Human needs to configure Railway services above
2. ‚úÖ **COMPLETED**: Dockerfile fixed and ready to deploy
3. ‚úÖ **COMPLETED**: All backend code ready (Sprints 4-6)
4. ‚è≥ **READY**: Continue with Sprint 7 tasks

---

## Contact

Once Railway services are deployed, please:
1. Verify all 3-4 services are running (API, Worker, Beat, Redis)
2. Check logs for errors in each service
3. Test the task health endpoint
4. Confirm scheduled tasks are running
5. Update this file with ‚úÖ when complete

**Expected time**: 20-30 minutes of manual configuration
